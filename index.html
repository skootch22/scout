<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Scout ‚Äî Baseball Scouting Reports</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --cream: #f5f0e8;
    --dark: #1a1208;
    --green: #1a3d1f;
    --green-light: #2d5a35;
    --dirt: #5a6472;
    --chalk: #f0ede4;
    --red: #8b1a1a;
    --blue: #1a2d4a;
    --ink: #2c1f0e;
    --line: rgba(26,18,8,0.12);
    --common: #1565c0; /* blue for common opponent */
    --common-light: #e3f0fd;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    background: var(--cream);
    color: var(--dark);
    font-family: 'IBM Plex Sans', sans-serif;
    font-weight: 300;
    min-height: 100vh;
    font-size: 16px;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    background: var(--green);
    color: var(--cream);
    padding: 14px 16px;
    display: flex;
    align-items: baseline;
    gap: 10px;
    border-bottom: 4px solid var(--dirt);
    position: sticky;
    top: 0;
    z-index: 200;
  }
  header h1 { font-family: 'Playfair Display', serif; font-size: 1.5rem; font-weight: 900; letter-spacing: .05em; text-transform: uppercase; line-height: 1; }
  header span { font-family: 'IBM Plex Mono', monospace; font-size: .62rem; opacity: .6; letter-spacing: .1em; text-transform: uppercase; }

  .container { padding: 16px; max-width: 1060px; margin: 0 auto; }

  .section-label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: .6rem; letter-spacing: .2em; text-transform: uppercase;
    color: var(--dirt); font-weight: 600; margin-bottom: 10px; display: block;
  }

  /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
  .card { background: white; border: 2px solid var(--dark); box-shadow: 4px 4px 0 var(--dark); padding: 16px; margin-bottom: 16px; }

  /* ‚îÄ‚îÄ FIELDS ‚îÄ‚îÄ */
  .field { display: flex; flex-direction: column; gap: 5px; }
  .field label { font-family: 'IBM Plex Mono', monospace; font-size: .6rem; letter-spacing: .15em; text-transform: uppercase; opacity: .55; }
  .field input {
    border: none; border-bottom: 2px solid var(--dark); padding: 10px 4px;
    font-family: 'IBM Plex Sans', sans-serif; font-size: 16px; font-weight: 500;
    background: transparent; color: var(--dark); outline: none; width: 100%;
    transition: border-color .2s; -webkit-appearance: none;
  }
  .field input:focus { border-color: var(--dirt); }

  /* ‚îÄ‚îÄ TEAM TABS ‚îÄ‚îÄ */
  #teamTabsWrap { display: none; border-top: 1px solid var(--line); padding-top: 14px; margin-top: 14px; }
  .team-tabs { display: flex; flex-wrap: wrap; gap: 8px; }
  .team-tab {
    font-family: 'IBM Plex Mono', monospace; font-size: .7rem; letter-spacing: .06em; text-transform: uppercase;
    padding: 10px 16px; border: 2px solid var(--dark); background: transparent; cursor: pointer;
    font-weight: 600; transition: all .15s; color: var(--dark); min-height: 44px;
  }
  .team-tab.active { background: var(--dark); color: var(--cream); }

  .sheet-hint {
    margin-top: 14px; font-family: 'IBM Plex Mono', monospace; font-size: .6rem;
    opacity: .42; line-height: 1.8; border-top: 1px solid var(--line); padding-top: 12px;
  }
  .sheet-hint strong { opacity: 1; color: var(--dirt); }

  /* ‚îÄ‚îÄ STATUS BAR ‚îÄ‚îÄ */
  #statusBar {
    display: none; padding: 12px 16px; font-family: 'IBM Plex Mono', monospace;
    font-size: .68rem; letter-spacing: .06em; border: 2px solid; margin-bottom: 16px;
    align-items: flex-start; gap: 10px; line-height: 1.5;
  }
  #statusBar.loading { background: #f0f4f8; border-color: var(--dirt); color: var(--dirt); display: flex; }
  #statusBar.success { background: #eaf3eb; border-color: var(--green); color: var(--green); display: flex; }
  #statusBar.error   { background: #fdf0f0; border-color: var(--red);   color: var(--red);   display: flex; }

  /* ‚îÄ‚îÄ META ‚îÄ‚îÄ */
  .meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

  /* ‚îÄ‚îÄ PANEL HEADER ‚îÄ‚îÄ */
  .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; gap: 8px; }
  .panel-title { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .panel-badge { font-family: 'IBM Plex Mono', monospace; font-size: .55rem; letter-spacing: .12em; text-transform: uppercase; padding: 3px 8px; border: 1.5px solid; font-weight: 600; }
  .panel-badge.pitching { border-color: var(--green); color: var(--green); }
  .panel-badge.batting  { border-color: var(--blue);  color: var(--blue);  }

  .refresh-btn {
    font-family: 'IBM Plex Mono', monospace; font-size: .65rem; letter-spacing: .08em; text-transform: uppercase;
    background: none; border: 2px solid var(--green); color: var(--green); padding: 8px 14px;
    cursor: pointer; font-weight: 600; min-height: 44px; white-space: nowrap;
  }
  .refresh-btn:disabled { opacity: .4; }

  /* ‚îÄ‚îÄ TABLES ‚îÄ‚îÄ */
  .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 0 -16px; padding: 0 16px; }
  table { width: 100%; border-collapse: collapse; min-width: 480px; }
  thead tr { background: var(--dark); color: var(--cream); }
  thead th {
    font-family: 'IBM Plex Mono', monospace; font-size: .58rem; letter-spacing: .1em;
    text-transform: uppercase; padding: 9px 10px; text-align: center; font-weight: 600; white-space: nowrap;
  }
  thead th:first-child { text-align: left; position: sticky; left: 0; background: var(--dark); z-index: 1; }
  thead th.calc-p { background: #1a2d0a; color: #7fba00; }
  thead th.calc-b { background: #0a1a2d; color: #5b9bd5; }
  thead th.opp-col { background: #0d4a8a; color: #b8d8f8; }

  tbody tr { border-bottom: 1px solid var(--line); }
  tbody tr.common-row { background: var(--common-light); }
  tbody tr.totals-row { background: var(--chalk); font-weight: 600; border-top: 2px solid var(--dark); }
  tbody tr.common-totals-row { background: #cce0f8; font-weight: 600; border-top: 2px solid var(--common); }

  tbody td { padding: 9px 10px; font-size: .84rem; text-align: center; font-family: 'IBM Plex Mono', monospace; }
  tbody td:first-child { text-align: left; font-weight: 600; position: sticky; left: 0; background: white; z-index: 1; }
  tbody tr.common-row td:first-child { background: var(--common-light); }
  tbody tr.totals-row td:first-child { background: var(--chalk); }
  tbody tr.common-totals-row td:first-child { background: #cce0f8; }
  tbody td.calc-p { background: rgba(127,186,0,.07); font-weight: 600; }
  tbody td.calc-b { background: rgba(91,155,213,.09); font-weight: 600; }
  tbody td.opp-name { font-family: 'IBM Plex Sans', sans-serif; font-size: .8rem; text-align: left; }
  tbody td.common-flag { font-size: .75rem; }

  .empty-state { text-align: center; padding: 32px 16px; color: var(--ink); opacity: .32; font-family: 'IBM Plex Mono', monospace; font-size: .7rem; letter-spacing: .1em; }

  /* ‚îÄ‚îÄ BATTING SUMMARY STRIP ‚îÄ‚îÄ */
  .summary-wrap { margin-bottom: 16px; }

  .summary-section-label {
    font-family: 'IBM Plex Mono', monospace; font-size: .56rem; letter-spacing: .18em;
    text-transform: uppercase; font-weight: 600; padding: 6px 10px;
    display: flex; align-items: center; gap: 6px;
  }
  .summary-section-label.season-lbl { background: var(--blue); color: rgba(255,255,255,.95); font-weight: 700; }
  .summary-section-label.common-lbl { background: var(--common); color: rgba(255,255,255,.95); font-weight: 700; }

  .batting-summary {
    display: grid; grid-template-columns: repeat(3,1fr);
    border: 2px solid var(--dark); overflow: hidden;
  }
  .batting-summary.common-summary { border-color: var(--common); }

  .bsum-item { padding: 12px 6px; text-align: center; border-right: 1px solid var(--line); background: var(--chalk); }
  .bsum-item:last-child { border-right: none; }
  .common-summary .bsum-item { background: var(--common-light); border-right-color: rgba(74,26,110,.1); }
  .bsum-label { font-family: 'IBM Plex Mono', monospace; font-size: .52rem; letter-spacing: .12em; text-transform: uppercase; font-weight: 700; color: var(--ink); margin-bottom: 2px; }
  .bsum-value { font-family: 'Playfair Display', serif; font-size: 1.3rem; font-weight: 900; line-height: 1; color: var(--blue); }
  .common-summary .bsum-value { color: var(--common); }
  .bsum-sub { font-family: 'IBM Plex Mono', monospace; font-size: .52rem; font-weight: 600; color: var(--ink); opacity: .6; margin-top: 2px; }

  /* ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ */
  .charts-section { margin-top: 16px; }
  .charts-label { font-family: 'IBM Plex Mono', monospace; font-size: .6rem; letter-spacing: .15em; text-transform: uppercase; color: var(--blue); opacity: .7; margin-bottom: 10px; font-weight: 600; }
  .charts-grid { display: flex; flex-direction: column; gap: 14px; }
  .chart-wrap { border: 1.5px solid var(--line); padding: 12px; background: var(--chalk); }
  .chart-title { font-family: 'IBM Plex Mono', monospace; font-size: .55rem; letter-spacing: .12em; text-transform: uppercase; opacity: .5; margin-bottom: 8px; }

  /* ‚îÄ‚îÄ GENERATE ‚îÄ‚îÄ */

  /* ‚îÄ‚îÄ REPORT ‚îÄ‚îÄ */
  #report { display: none; background: white; border: 2px solid var(--dark); box-shadow: 4px 4px 0 var(--dark); overflow: hidden; animation: slideIn .35s ease; }
  @keyframes slideIn { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }

  .report-masthead { background: var(--dark); color: var(--cream); padding: 20px 16px; }
  .masthead-eyebrow { font-family: 'IBM Plex Mono', monospace; font-size: .55rem; letter-spacing: .2em; opacity: .4; text-transform: uppercase; margin-bottom: 4px; }
  .masthead-team { font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 900; letter-spacing: .02em; line-height: 1; margin-bottom: 8px; }
  .masthead-meta { font-family: 'IBM Plex Mono', monospace; font-size: .62rem; opacity: .45; letter-spacing: .08em; line-height: 1.7; }

  .report-strip { display: grid; grid-template-columns: repeat(3,1fr); }
  .report-strip.pitching-strip { border-top: 3px solid var(--dirt); background: var(--dirt); }
  .report-strip.batting-strip  { border-top: 3px solid var(--blue); background: var(--blue); }
  .report-strip.common-strip   { border-top: 3px solid var(--common); background: var(--common); }

  .strip-eyebrow { grid-column: 1/-1; font-family: 'IBM Plex Mono', monospace; font-size: .52rem; letter-spacing: .18em; text-transform: uppercase; font-weight: 700; padding: 7px 12px 3px; color: rgba(255,255,255,.95); border-bottom: 1px solid rgba(255,255,255,.2); }
  .rstat { padding: 11px 6px; text-align: center; border-right: 1px solid rgba(255,255,255,.15); color: var(--cream); }
  .rstat:last-child { border-right: none; }
  .rstat-val { font-family: 'Playfair Display', serif; font-size: 1.3rem; font-weight: 900; line-height: 1; display: block; }
  .rstat-lbl { font-family: 'IBM Plex Mono', monospace; font-size: .46rem; letter-spacing: .1em; text-transform: uppercase; font-weight: 700; color: rgba(255,255,255,.95); margin-top: 2px; display: block; }
  .rstat-sub { font-family: 'IBM Plex Mono', monospace; font-size: .5rem; opacity: .5; display: block; margin-top: 1px; }

  .report-section { padding: 16px; border-top: 1px solid var(--line); }
  .report-section-heading { font-family: 'IBM Plex Mono', monospace; font-size: .58rem; letter-spacing: .18em; text-transform: uppercase; font-weight: 600; padding-bottom: 8px; margin-bottom: 12px; border-bottom: 2px solid; }
  .report-section-heading.pitching { border-color: var(--dirt); color: var(--dirt); }
  .report-section-heading.batting  { border-color: var(--blue);  color: var(--blue);  }
  .report-section-heading.common   { border-color: var(--common); color: var(--common); }
  .report-section-heading.findings { border-color: var(--dark); color: var(--dark); }

  /* Pitcher row */
  .pitcher-row { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--chalk); border: 1.5px solid var(--dark); margin-bottom: 8px; }
  .pr-num { font-family: 'Playfair Display', serif; font-weight: 900; font-size: 1.6rem; line-height: 1; min-width: 44px; text-align: center; }
  .pr-stats { flex: 1; display: grid; grid-template-columns: repeat(3,1fr); gap: 6px 8px; }
  .prs .v { font-family: 'IBM Plex Mono', monospace; font-size: .82rem; font-weight: 600; display: block; }
  .prs .l { font-family: 'IBM Plex Mono', monospace; font-size: .46rem; letter-spacing: .1em; text-transform: uppercase; font-weight: 700; color: var(--ink); display: block; }
  .prs.hi .v { color: var(--dirt); }
  .pr-grade { width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0; margin-top: 4px; border: 1.5px solid rgba(0,0,0,.2); }
  .grade-A { background: #2d5a35; color: white; }
  .grade-B { background: #4a7c59; color: white; }
  .grade-C { background: #c9a800; color: white; }
  .grade-D { background: #a0522d; color: white; }
  .grade-F { background: var(--red); color: white; }

  /* Batting report cards */
  .bat-report-card { border: 1.5px solid var(--blue); background: #f0f4fa; padding: 14px; margin-bottom: 12px; }
  .bat-report-card.common-card { border-color: var(--common); background: var(--common-light); }

  .bat-card-label { font-family: 'IBM Plex Mono', monospace; font-size: .55rem; letter-spacing: .15em; text-transform: uppercase; font-weight: 600; margin-bottom: 10px; color: var(--blue); }
  .bat-report-card.common-card .bat-card-label { color: var(--common); }

  .bat-kpis { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin-bottom: 12px; }
  .bkpi { text-align: center; }
  .bkpi .bv { font-family: 'Playfair Display', serif; font-size: 1.3rem; font-weight: 900; color: var(--blue); display: block; line-height: 1; }
  .common-card .bkpi .bv { color: var(--common); }
  .bkpi .bl { font-family: 'IBM Plex Mono', monospace; font-size: .46rem; letter-spacing: .1em; text-transform: uppercase; opacity: .5; display: block; margin-top: 2px; }
  .bat-divider { border: none; border-top: 1px solid var(--line); margin: 10px 0; }
  .bat-totals-label { font-family: 'IBM Plex Mono', monospace; font-size: .55rem; letter-spacing: .1em; text-transform: uppercase; opacity: .4; margin-bottom: 6px; }
  .bat-raw { display: grid; grid-template-columns: repeat(5,1fr); gap: 6px; }
  .brt .rv { font-family: 'IBM Plex Mono', monospace; font-size: .85rem; font-weight: 600; display: block; }
  .brt .rl { font-family: 'IBM Plex Mono', monospace; font-size: .46rem; letter-spacing: .1em; text-transform: uppercase; opacity: .38; display: block; }

  /* Common opponent name display */
  .common-opp-name {
    font-family: 'Playfair Display', serif; font-weight: 700; font-size: .95rem;
    color: var(--common); margin-bottom: 8px;
  }
  .common-games-count { font-family: 'IBM Plex Mono', monospace; font-size: .55rem; opacity: .5; text-transform: uppercase; letter-spacing: .1em; }

  /* Findings */
  .findings-grid { display: flex; flex-direction: column; gap: 10px; }
  .finding { padding: 12px; border-left: 4px solid var(--dirt); background: var(--chalk); }
  .finding.strength { border-left-color: var(--green); }
  .finding.weakness { border-left-color: var(--red); }
  .finding-type { font-family: 'IBM Plex Mono', monospace; font-size: .55rem; letter-spacing: .12em; text-transform: uppercase; font-weight: 600; opacity: .55; margin-bottom: 3px; }
  .finding p { font-size: .84rem; line-height: 1.5; }

  /* Narrative */

  /* Dots */

  /* No common opponent notice */
  .no-common-notice {
    font-family: 'IBM Plex Mono', monospace; font-size: .65rem; letter-spacing: .06em;
    color: var(--common); opacity: .6; padding: 10px; border: 1px dashed var(--common);
    background: var(--common-light); line-height: 1.6;
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     DESKTOP (min-width: 700px)
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  @media (min-width: 700px) {
    header { padding: 18px 32px; }
    header h1 { font-size: 2rem; }
    .container { padding: 28px 24px; }
    .card { padding: 24px; box-shadow: 5px 5px 0 var(--dark); }
    .charts-grid { flex-direction: row; }
    .chart-wrap { flex: 1; }
    .report-masthead { padding: 28px 28px; display: grid; grid-template-columns: 1fr auto; align-items: end; gap: 16px; }
    .masthead-meta { text-align: right; }
    .report-dual-strip { display: grid; grid-template-columns: 1fr 1fr; }
    .report-strip.pitching-strip { border-top: none; border-right: 2px solid rgba(255,255,255,.1); }
    .report-strip.batting-strip  { border-top: none; }
    .report-columns { display: grid; grid-template-columns: 1fr 1fr; }
    .report-col-left { border-right: 1px solid var(--line); }
    .findings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .rstat-val { font-size: 1.5rem; }
  }

  @media (min-width: 900px) {
    .container { padding: 36px 32px; }
    .card { padding: 28px; }
    .masthead-team { font-size: 2.4rem; }
  }
</style>
</head>
<body>

<header>
  <h1>Scout</h1>
  <span>Scouting Reports</span>
</header>

<div class="container">

  <!-- Team Selector -->
  <div class="card">
    <span class="section-label">Select Team</span>
    <div style="display:flex;gap:10px;align-items:flex-end">
      <div class="field" style="flex:1">
        <label>Team</label>
        <select id="teamSelect" style="
          border:none;border-bottom:2px solid var(--dark);padding:10px 4px;
          font-family:'IBM Plex Sans',sans-serif;font-size:16px;font-weight:500;
          background:transparent;color:var(--dark);outline:none;width:100%;
          -webkit-appearance:none;appearance:none;cursor:pointer;
          background-image:url('data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'><path d='M1 1l5 5 5-5' stroke='%231a1208' stroke-width='2' fill='none'/></svg>');
          background-repeat:no-repeat;background-position:right 4px center;padding-right:24px;
        ">
          <option value="">‚Äî loading teams‚Ä¶ ‚Äî</option>
        </select>
      </div>
      <button onclick="onLoadClick()" id="connectBtn" style="
        font-family:'IBM Plex Mono',monospace;font-size:.7rem;letter-spacing:.08em;text-transform:uppercase;
        font-weight:600;background:var(--green);color:var(--cream);border:2px solid var(--green);
        padding:10px 16px;cursor:pointer;white-space:nowrap;min-height:44px;flex-shrink:0;
        box-shadow:3px 3px 0 var(--dark);transition:all .15s;
      ">Load</button>
    </div>
  </div>

  <!-- Status -->
  <div id="statusBar"></div>

  <!-- Report -->
  <div id="report"></div>



</div>

<script>
'use strict';

let pitchers    = [];
let games       = [];
let currentTeam = '';
let sheetId     = '11RIKkgh2hpozY3boJ6iqK_XA9-iurofS7Z5ZyECCa8A'; // hardcoded

const $ = id => document.getElementById(id);

function extractSheetId(url) {
  const m = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
  return m ? m[1] : null;
}
function buildCsvUrl(id, tab) {
  return `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tab)}`;
}
function setStatus(type, msg) {
  const bar = $('statusBar');
  bar.className = type;
  bar.innerHTML = type === 'loading'
    ? `<div class="dots"><span></span><span></span><span></span></div><span>${msg}</span>`
    : (type === 'success' ? `<span>&#x2714; ${msg}</span>` : `<span>&#x2716; ${msg}</span>`);
}
function fmt(n, d = 3) { return n.toFixed(d).replace(/^0\./, '.'); }

function escRe(s) { return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

// ‚îÄ‚îÄ Fetch Teams tab and populate dropdown (runs on page load) ‚îÄ‚îÄ
async function fetchTeamList() {
  try {
    const text = await fetchCsv('Teams');
    const lines = text.trim().split('\n').slice(1);
    const teams = lines
      .map(l => parseCsvLine(l)[0].trim())
      .filter(Boolean);
    if (!teams.length) throw new Error('No teams found.');
    const sel = $('teamSelect');
    sel.innerHTML = '<option value="">‚Äî select a team ‚Äî</option>' +
      teams.map(t => `<option value="${t}">${t}</option>`).join('');
    setStatus('success', `${teams.length} team${teams.length !== 1 ? 's' : ''} ready. Select one and tap Load.`);
  } catch(e) {
    setStatus('error', `Could not load team list: ${e.message}`);
  }
}

// ‚îÄ‚îÄ Step 2: load selected team's data ‚îÄ‚îÄ
function onLoadClick() {
  const team = $('teamSelect').value;
  if (!team) { setStatus('error', 'Please select a team from the dropdown.'); return; }
  if (!sheetId) { setStatus('error', 'Please connect to a sheet first.'); return; }
  selectTeam(team);
}
// ‚îÄ‚îÄ CSV ‚îÄ‚îÄ
function parseCsvLine(line) {
  const r = []; let cur = '', inQ = false;
  for (const ch of line) {
    if (ch === '"') { inQ = !inQ; }
    else if (ch === ',' && !inQ) { r.push(cur.trim()); cur = ''; }
    else cur += ch;
  }
  r.push(cur.trim());
  return r;
}
function colIdx(headers, ...candidates) {
  for (const c of candidates) {
    const i = headers.findIndex(h => h === c || h.startsWith(c));
    if (i !== -1) return i;
  }
  return -1;
}
function cell(row, col, fallback) {
  return (col !== -1 && row[col] !== undefined) ? row[col] : (row[fallback] || '');
}

function parsePitchingCsv(text) {
  const lines = text.trim().split('\n');
  if (lines.length < 2) return [];
  const h = parseCsvLine(lines[0]).map(s => s.toLowerCase().replace(/[^a-z]/g,''));
  const cNum = colIdx(h,'number','num','jersey','no');
  const cIP  = colIdx(h,'ip','innings');
  const cPit = colIdx(h,'pitches','pitch');
  const cStr = colIdx(h,'strikes','strike');
  const cBB  = colIdx(h,'bb','walks','walk');
  const cK   = colIdx(h,'k','strikeout','so');
  return lines.slice(1).map(l => {
    const r = parseCsvLine(l);
    if (r.every(c => c === '')) return null;
    const num     = cell(r,cNum,0) || '?';
    const ip      = parseFloat(cell(r,cIP,1))  || 0;
    const pitches = parseInt(cell(r,cPit,2))   || 0;
    const strikes = parseInt(cell(r,cStr,3))   || 0;
    const bb      = parseInt(cell(r,cBB,4))    || 0;
    const k       = parseInt(cell(r,cK,5))     || 0;
    if (ip === 0 && pitches === 0 && k === 0) return null;
    return { num, ip, pitches, strikes, bb, k,
      strikePct: pitches > 0 ? strikes/pitches*100 : 0,
      bbk: k > 0 ? bb/k : null };
  }).filter(Boolean);
}

// Batting: Game | AB | R | H | RBI | BB | SO | Opponent | Common
function parseBattingCsv(text) {
  const lines = text.trim().split('\n');
  if (lines.length < 2) return [];
  const h = parseCsvLine(lines[0]).map(s => s.toLowerCase().replace(/[^a-z]/g,''));
  const cGame = colIdx(h,'game','gm','g');
  const cAB   = colIdx(h,'ab','atbat');
  const cR    = colIdx(h,'r','runs','run');
  const cH    = colIdx(h,'h','hits','hit');
  const cRBI  = colIdx(h,'rbi');
  const cBB   = colIdx(h,'bb','walks','walk');
  const cSO   = colIdx(h,'so','strikeout','k');
  const cOpp  = colIdx(h,'opponent','opp','opponent');
  const cCom  = colIdx(h,'common','co','flag');

  return lines.slice(1).map((l, i) => {
    const r = parseCsvLine(l);
    if (r.every(c => c === '')) return null;
    const game     = cell(r,cGame,0) || String(i+1);
    const ab       = parseInt(cell(r,cAB,1))  || 0;
    const run      = parseInt(cell(r,cR,2))   || 0;
    const hits     = parseInt(cell(r,cH,3))   || 0;
    const rbi      = parseInt(cell(r,cRBI,4)) || 0;
    const bb       = parseInt(cell(r,cBB,5))  || 0;
    const so       = parseInt(cell(r,cSO,6))  || 0;
    const opponent = cOpp !== -1 ? (r[cOpp] || '').trim() : '';
    const common   = cCom !== -1 ? (r[cCom] || '0').trim() === '1' : false;
    if (ab === 0) return null;
    return { game, ab, run, h: hits, rbi, bb, so, opponent, common,
      avg:  ab > 0 ? hits/ab : 0,
      obp:  (ab+bb) > 0 ? (hits+bb)/(ab+bb) : 0,
      sobb: bb > 0 ? so/bb : null };
  }).filter(Boolean);
}

// ‚îÄ‚îÄ Aggregates ‚îÄ‚îÄ
function calcTotals(gs) {
  if (!gs.length) return null;
  const ab  = gs.reduce((s,g) => s+g.ab, 0);
  const h   = gs.reduce((s,g) => s+g.h, 0);
  const r   = gs.reduce((s,g) => s+g.run, 0);
  const rbi = gs.reduce((s,g) => s+g.rbi, 0);
  const bb  = gs.reduce((s,g) => s+g.bb, 0);
  const so  = gs.reduce((s,g) => s+g.so, 0);
  return { ab, h, r, rbi, bb, so, count: gs.length,
    avg:  ab > 0 ? h/ab : 0,
    obp:  (ab+bb) > 0 ? (h+bb)/(ab+bb) : 0,
    sobb: bb > 0 ? so/bb : null };
}

// Derive common opponent name (most frequent opponent with common=true)
function commonOpponentName(gs) {
  const commonGames = gs.filter(g => g.common);
  if (!commonGames.length) return '';
  const counts = {};
  commonGames.forEach(g => { if (g.opponent) counts[g.opponent] = (counts[g.opponent]||0)+1; });
  const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]);
  // If multiple opponents flagged, return comma-joined list; usually just one
  return sorted.map(([name]) => name).join(', ');
}

// ‚îÄ‚îÄ Load Team (builds tab names directly from team name) ‚îÄ‚îÄ
async function selectTeam(team) {
  currentTeam = team;
  setStatus('loading', `Loading ${team}‚Ä¶`);

  const pitchTab = `${team} - Pitching`;
  const batTab   = `${team} - Batting`;

  pitchers = [];
  let pitchError = null;
  try {
    pitchers = parsePitchingCsv(await fetchCsv(pitchTab));
  } catch(e) {
    pitchError = e.message;
  }

  games = [];
  let batError = null;
  try {
    games = parseBattingCsv(await fetchCsv(batTab));
  } catch(e) {
    batError = e.message;
  }


  [].forEach(id => {
    $(id).style.display = 'block';
  });

  const parts = [];
  if (pitchers.length) parts.push(`${pitchers.length} pitchers`);
  if (games.length)    parts.push(`${games.length} games`);

  if (!pitchers.length && !games.length) {
    const detail = pitchError || batError || 'unknown error';
    setStatus('error', `No data loaded ‚Äî ${detail}. Tried: "${pitchTab}" and "${batTab}"`);
    } else {
    setStatus('loading', `${team}: ${parts.join(' ¬∑ ')} loaded. Generating report‚Ä¶`);
      await generateReport();
  }
}

async function fetchCsv(tab) {
  const resp = await fetch(buildCsvUrl(sheetId, tab));
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  const text = await resp.text();
  if (text.includes('Sign in') || text.trim().startsWith('<')) throw new Error('Sheet not public.');
  return text;
}

function reloadCurrentTeam() { if (currentTeam) selectTeam(currentTeam); }

// ‚îÄ‚îÄ Render Pitching ‚îÄ‚îÄ
function renderPitchingTable() {
  const tbody = $('pitchingBody');
  if (!pitchers.length) {
    tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state">No pitching data</div></td></tr>';
    return;
  }
  tbody.innerHTML = pitchers.map(p => `
    <tr>
      <td>#${p.num}</td><td>${p.ipDisplay}</td><td>${p.pitches}</td><td>${p.strikes}</td>
      <td>${p.bb}</td><td>${p.k}</td>
      <td class="calc-p">${p.strikePct.toFixed(1)}%</td>
      <td class="calc-p">${p.bbk !== null ? p.bbk.toFixed(2) : '‚Äî'}</td>
    </tr>
  `).join('');
}

// ‚îÄ‚îÄ Render Batting Panel ‚îÄ‚îÄ
// batting data is used directly by generateReport via the games[] array

// ‚îÄ‚îÄ Charts ‚îÄ‚îÄ

// ‚îÄ‚îÄ Pitching stats for report ‚îÄ‚îÄ
function ipToDecimal(ip) {
  // Baseball IP: 6.2 means 6 innings + 2 outs = 6.667 decimal
  const innings = Math.floor(ip);
  const outs    = Math.round((ip % 1) * 10); // e.g. 0.2 -> 2 outs
  return innings + outs / 3;
}

function decimalToIp(dec) {
  // Convert decimal innings back to baseball notation
  // e.g. 6.667 -> "6.2", 7.0 -> "7.0", 4.333 -> "4.1"
  const innings = Math.floor(dec + 0.001); // small epsilon for float safety
  const remainder = dec - innings;
  const outs = Math.min(2, Math.round(remainder * 3)); // clamp to 0,1,2
  return innings + '.' + outs;
}

function computePitchingStats() {
  // Roll up multiple outings per pitcher by jersey number
  const byNum = {};
  pitchers.forEach(p => {
    if (!byNum[p.num]) {
      byNum[p.num] = { num: p.num, ip: 0, pitches: 0, strikes: 0, bb: 0, k: 0, outings: 0 };
    }
    byNum[p.num].ip      += ipToDecimal(p.ip);
    byNum[p.num].pitches += p.pitches;
    byNum[p.num].strikes += p.strikes;
    byNum[p.num].bb      += p.bb;
    byNum[p.num].k       += p.k;
    byNum[p.num].outings += 1;
  });

  return Object.values(byNum).map(p => {
    const ipDec     = p.ip; // already decimal from rollup
    const kper9     = ipDec > 0 ? p.k/ipDec*9 : 0;
    const bbper9    = ipDec > 0 ? p.bb/ipDec*9 : 0;
    const kbb       = p.bb > 0 ? p.k/p.bb : p.k;
    const strikePct = p.pitches > 0 ? p.strikes/p.pitches*100 : 0;
    const bbk       = p.k > 0 ? p.bb/p.k : null;
    // Display IP back in baseball notation (e.g. 6.667 -> 6.2)
    const ipDisplay = decimalToIp(ipDec);
    let s = 0;
    if (kper9 >= 10) s+=3; else if (kper9 >= 8) s+=2; else if (kper9 >= 6) s+=1;
    if (bbper9 <= 2) s+=3; else if (bbper9 <= 3.5) s+=2; else if (bbper9 <= 5) s+=1;
    if (kbb >= 3) s+=2; else if (kbb >= 2) s+=1;
    if (strikePct >= 65) s+=1;
    const grade = s>=7?'A':s>=5?'B':s>=3?'C':s>=1?'D':'F';
    return { ...p, ipDec, ipDisplay, strikePct, bbk, kper9, bbper9, kbb, grade };
  });
}

function pitchingAgg(stats) {
  const ip = stats.reduce((s,p) => s+p.ipDec,0);
  const k  = stats.reduce((s,p) => s+p.k,0);
  const bb = stats.reduce((s,p) => s+p.bb,0);
  const st = stats.reduce((s,p) => s+p.strikes,0);
  const pi = stats.reduce((s,p) => s+p.pitches,0);
  const ipDisplay = decimalToIp(ip);
  return {
    totalIP: ipDisplay, totalK: k, totalBB: bb,
    teamKper9:     ip>0 ? (k/ip*9).toFixed(2)    : '‚Äî',
    teamStrikePct: pi>0 ? (st/pi*100).toFixed(1) : '‚Äî',
    teamBBK:       k>0  ? (bb/k).toFixed(2)       : '‚Äî',
  };
}

// ‚îÄ‚îÄ Generate Report ‚îÄ‚îÄ
async function generateReport() {
  if (!pitchers.length && !games.length) { alert('No data loaded. Select a team first.'); return; }
  const season     = new Date().getFullYear().toString();
  const leagueName = '';
  const teamName   = currentTeam         || 'Unknown Team';


  const pStats      = computePitchingStats();
  const pAgg        = pitchingAgg(pStats);
  const tot         = games.length ? calcTotals(games) : null;
  const commonGames = games.filter(g => g.common);
  const coTot       = calcTotals(commonGames);
  const coName      = commonOpponentName(games);

  const reportEl = $('report');
  reportEl.style.display = 'block';
  reportEl.innerHTML = buildReportHTML(teamName, season, leagueName, pStats, pAgg, tot, coTot, coName);

  reportEl.innerHTML = buildReportHTML(teamName, season, leagueName, pStats, pAgg, tot, coTot, coName);
  $('statusBar').className = '';
  $('statusBar').innerHTML = '';
}

// ‚îÄ‚îÄ Build Report HTML ‚îÄ‚îÄ
function buildReportHTML(teamName, season, leagueName, pStats, pAgg, tot, coTot, coName) {
  const now = new Date().toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});

  const pitcherRows = pStats.map(p => `
    <div class="pitcher-row">
      <div class="pr-num">#${p.num}</div>
      <div class="pr-stats">
        <div class="prs"><span class="v">${p.ipDisplay}</span><span class="l">IP</span></div>
        <div class="prs"><span class="v">${p.k}</span><span class="l">K</span></div>
        <div class="prs"><span class="v">${p.bb}</span><span class="l">BB</span></div>
        <div class="prs hi"><span class="v">${p.strikePct.toFixed(1)}%</span><span class="l">Str%</span></div>
        <div class="prs hi"><span class="v">${p.bbk!==null?p.bbk.toFixed(2):'‚Äî'}</span><span class="l">BB/K</span></div>
        <div class="prs"><span class="v">${p.kper9.toFixed(1)}</span><span class="l">K/9</span></div>
      </div>
      <div class="pr-grade grade-${p.grade}"></div>
    </div>
  `).join('') || '<p style="opacity:.4;font-style:italic;font-size:.82rem;padding:8px 0">No pitching data loaded.</p>';

  // Season batting card
  let batCard = '<p style="opacity:.4;font-style:italic;font-size:.82rem;padding:8px 0">No batting data loaded.</p>';
  if (tot) {
    batCard = `
      <div class="bat-report-card">
        <div class="bat-card-label">üìä Season ‚Äî ${tot.count} game${tot.count!==1?'s':''}</div>
        <div class="bat-kpis">
          <div class="bkpi"><span class="bv">${fmt(tot.avg)}</span><span class="bl">AVG</span></div>
          <div class="bkpi"><span class="bv">${fmt(tot.obp)}</span><span class="bl">OBP</span></div>
          <div class="bkpi"><span class="bv">${tot.sobb!==null?tot.sobb.toFixed(2):'‚Äî'}</span><span class="bl">SO/BB</span></div>
        </div>

      </div>`;
  }

  // Common opponent card
  let coCard = '';
  if (coTot && coTot.count > 0) {
    const avgDiff  = tot ? (coTot.avg  - tot.avg) : 0;
    const obpDiff  = tot ? (coTot.obp  - tot.obp) : 0;
    const diffSign = n => n > 0.005 ? `‚ñ≤ +${fmt(Math.abs(n))}` : n < -0.005 ? `‚ñº ${fmt(Math.abs(n))}` : '‚âà same';
    coCard = `
      <div class="bat-report-card common-card">
        <div class="bat-card-label">üéØ Common Opponent${coName ? ' ‚Äî '+coName : ''} (${coTot.count} game${coTot.count!==1?'s':''})</div>
        <div class="bat-kpis">
          <div class="bkpi">
            <span class="bv">${fmt(coTot.avg)}</span>
            <span class="bl">AVG</span>
            ${tot ? `<span style="font-family:'IBM Plex Mono',monospace;font-size:.55rem;display:block;margin-top:2px;opacity:.6">${diffSign(avgDiff)}</span>` : ''}
          </div>
          <div class="bkpi">
            <span class="bv">${fmt(coTot.obp)}</span>
            <span class="bl">OBP</span>
            ${tot ? `<span style="font-family:'IBM Plex Mono',monospace;font-size:.55rem;display:block;margin-top:2px;opacity:.6">${diffSign(obpDiff)}</span>` : ''}
          </div>
          <div class="bkpi">
            <span class="bv">${coTot.sobb!==null?coTot.sobb.toFixed(2):'‚Äî'}</span>
            <span class="bl">SO/BB</span>
          </div>
        </div>

      </div>`;
  }

  const strengths  = getStrengths(pStats, pAgg, tot, coTot, coName);
  const weaknesses = getWeaknesses(pStats, pAgg, tot, coTot, coName);

  const batAVG  = tot ? fmt(tot.avg)  : '‚Äî';
  const batOBP  = tot ? fmt(tot.obp)  : '‚Äî';
  const batSOBB = tot && tot.sobb !== null ? tot.sobb.toFixed(2) : '‚Äî';
  const coAVG   = coTot ? fmt(coTot.avg)  : '‚Äî';
  const coOBP   = coTot ? fmt(coTot.obp)  : '‚Äî';
  const coSOBB  = coTot && coTot.sobb !== null ? coTot.sobb.toFixed(2) : '‚Äî';

  return `
    <div class="report-masthead">
      <div>
        <div class="masthead-eyebrow">Full Team Scouting Report</div>
        <div class="masthead-team">${teamName}</div>
        <div class="masthead-meta">${now}</div>
      </div>
    </div>

    <div class="report-dual-strip">
      <div class="report-strip pitching-strip">
        <div class="strip-eyebrow">‚öæ Pitching</div>
        <div class="rstat"><span class="rstat-val">${pAgg.teamStrikePct}%</span><span class="rstat-lbl">Strike Rate</span></div>
        <div class="rstat"><span class="rstat-val">${pAgg.teamBBK}</span><span class="rstat-lbl">BB / K</span></div>
        <div class="rstat"><span class="rstat-val">${pAgg.teamKper9}</span><span class="rstat-lbl">K / 9</span></div>
      </div>
      <div class="report-strip batting-strip">
        <div class="strip-eyebrow">üìä Season Batting${tot ? ' ('+tot.count+'g)' : ''}</div>
        <div class="rstat"><span class="rstat-val">${batAVG}</span><span class="rstat-lbl">AVG</span></div>
        <div class="rstat"><span class="rstat-val">${batOBP}</span><span class="rstat-lbl">OBP</span></div>
        <div class="rstat"><span class="rstat-val">${batSOBB}</span><span class="rstat-lbl">SO/BB</span></div>
      </div>
    </div>

    ${coTot && coTot.count > 0 ? `
    <div class="report-strip common-strip">
      <div class="strip-eyebrow">üéØ Common Opponent${coName ? ' ‚Äî '+coName : ''}${coTot ? ' ('+coTot.count+'g)' : ''}</div>
      <div class="rstat"><span class="rstat-val">${coAVG}</span><span class="rstat-lbl">AVG</span></div>
      <div class="rstat"><span class="rstat-val">${coOBP}</span><span class="rstat-lbl">OBP</span></div>
      <div class="rstat"><span class="rstat-val">${coSOBB}</span><span class="rstat-lbl">SO/BB</span></div>
    </div>` : ''}

    <div class="report-section">
      <div class="report-section-heading pitching">‚öæ Pitching Staff</div>
      ${pitcherRows}
    </div>

    <div class="report-section">
      <div class="report-section-heading findings">Key Findings</div>
      <div class="findings-grid">
        ${strengths.map(s  => `<div class="finding strength"><div class="finding-type">‚ú¶ Strength</div><p>${s}</p></div>`).join('')}
        ${weaknesses.map(w => `<div class="finding weakness"><div class="finding-type">‚ñ≤ Concern</div><p>${w}</p></div>`).join('')}
      </div>
    </div>


  `;
}

function getStrengths(pStats, pAgg, tot, coTot, coName) {
  const out = [];
  if (pStats.length) {
    const ace = pStats.reduce((a,b) => b.kper9>a.kper9?b:a, pStats[0]);
    if (ace) out.push(`#${ace.num} leads the staff at ${ace.kper9.toFixed(2)} K/9 ‚Äî a premier swing-and-miss arm.`);
    if (parseFloat(pAgg.teamStrikePct) >= 62)
      out.push(`Staff strike rate of ${pAgg.teamStrikePct}% reflects consistent ability to work ahead in counts.`);
  }
  if (tot) {
    if (tot.avg >= .270) out.push(`Season AVG of ${fmt(tot.avg)} signals a dangerous, contact-oriented lineup.`);
    if (tot.obp >= .340) out.push(`Season OBP of ${fmt(tot.obp)} demonstrates strong plate discipline.`);
  }
  if (coTot && coTot.count > 0 && tot) {
    if (coTot.avg > tot.avg + .015)
      out.push(`Team hits notably better vs. ${coName || 'the common opponent'} ‚Äî AVG ${fmt(coTot.avg)} vs. season ${fmt(tot.avg)}.`);
  }
  return out.slice(0,3);
}

function getWeaknesses(pStats, pAgg, tot, coTot, coName) {
  const out = [];
  if (pStats.length) {
    const wildest = pStats.reduce((a,b) => b.bbper9>a.bbper9?b:a, pStats[0]);
    if (wildest && wildest.bbper9 > 4)
      out.push(`#${wildest.num} is the control liability at ${wildest.bbper9.toFixed(2)} BB/9 ‚Äî patient approaches yield free passes.`);
    if (parseFloat(pAgg.teamStrikePct) < 60)
      out.push(`Staff strike rate of ${pAgg.teamStrikePct}% is below norms ‚Äî work counts to inflate pitch totals.`);
  }
  if (tot) {
    if (tot.sobb !== null && tot.sobb > 2.5)
      out.push(`SO/BB of ${tot.sobb.toFixed(2)} exposes swing-heavy tendencies ‚Äî challenge this lineup with strikes.`);
    if (tot.obp < .310)
      out.push(`Season OBP of ${fmt(tot.obp)} reveals limited plate discipline ‚Äî pitchers can attack confidently.`);
  }
  if (coTot && coTot.count > 0 && tot) {
    if (coTot.avg < tot.avg - .015)
      out.push(`Team struggles vs. ${coName || 'the common opponent'} ‚Äî AVG drops to ${fmt(coTot.avg)} vs. season ${fmt(tot.avg)}.`);
  }
  return out.slice(0,3);
}

// Enter key on either input triggers load
// Teams load automatically on page load via fetchTeamList() below
fetchTeamList();
</script>
</body>
</html>
